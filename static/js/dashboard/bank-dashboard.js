import { sanitizeText } from "../utils.js";
import { AlertUtils } from "../alerts.js";
import { checkIfHTMLElement } from "../utils.js";
import { cardImplementer, createCardDetails } from "../card/cardBuilder.js";
import { minimumCharactersToUse } from "../utils/password/textboxCharEnforcer.js";
import { deselectAllElements, selectElement } from "../utils.js";
import { warnError } from "../logger.js";


const connectWalletModal          = document.getElementById("connect-wallet-modal");
const connectWalletStepOne        = document.getElementById("connect-wallet-modal__step-one");
const connectWalletStepThree      = document.getElementById("connect-wallet-modal__step-three");
const connectWalletStepTwo        = document.getElementById("connect-wallet-modal__step-two");
const dashboard                   = document.getElementById("dashboard");
const dashboardProfileElement     = document.getElementById("dashboard-profile");
const dropdownMenu                = document.getElementById("dashboard__container__dropdown-menu");
const linkAccountForm             = document.getElementById("link-wallet-form");
const progressElement             = document.getElementById("walletProgress");
const progressValue               = document.getElementById("walletProgressValue");
const walletAuthForm              = document.getElementById("connect-wallet-form");
const walletAuthInputFieldPanel   = document.getElementById("connect-with-wallet-id");
const walletManualForm            = document.getElementById("manually-verification-wallet-form");
const walletManualFormSection     = document.getElementById("link-wallet-verifcation");
const walletOptionAuthInputFields = document.querySelectorAll("#connect-wallet-auth-id-wrapper input");
const statusWalletDisconnectPanel = document.getElementById("dashboard__status")
const disconnectInputFieldElement = document.getElementById("wallet-disconnect-inputfield");
const disconnectConfirmaionPanel  = document.getElementById("wallet-disconnection-confirmation");
const amountInputField            = document.getElementById("account-card__amount");
const bankCardSelectionTypes      = document.querySelectorAll(".account-card");
const addFundsToBankPanel         = document.getElementById("bank-account-add-funds");
const viewBankTransacionPanel     = document.getElementById("bank-account-view-transactions");
const fullCardDetailsContainer    = document.getElementById("full-card-details");
const cardDetailsContainer        = document.getElementById("full-card-details-info");
const bankCardButtons             = document.querySelector(".view-card-panel-buttons");
let creditCardsNodeElements       = document.querySelectorAll(".bank-card");

const viewExtraCardInfo           = document.getElementById("view-more-bank-card");
const extraCardInfoPanel          = document.getElementById("view-card-panel");
const cardTransferFormSection     = document.getElementById("bank-funds-transfer");
const selectCardsContainer        = document.getElementById("bank-funds-transfer__select-cards-panel");

const transferFormTextArea        = document.getElementById("bank-transfer-note");


console.log(transferFormTextArea)

const MAX_TRANSFER_AMOUNT = 1_000_000;
let walletModalStep2Button;

const excludeFields = new Set(["username",  "email", "wallet-disconnect-inputfield", "transfer-type", "from", "to", "transaction-type", "transfer-amount"]);
const excludeTypes = new Set(["checkbox", "radio", "password", "email", "textarea"]);


// controls the number of characters the user can use in the textarea form for the transfer
minimumCharactersToUse(transferFormTextArea, {
    minCharClass: ".num-of-characters-remaining",
    maxCharClass: ".num-of-characters-to-use",
    minCharMessage: "Minimum characters to use: ",
    maxCharMessage: "Number of characters remaining: ",
    minCharsLimit: 50,
    maxCharsLimit: 255,
    disablePaste: true,
})



// Constants for wallet modal element IDs
const WalletWizardIds = {
    AUTH_CANCEL_BTN: "auth-wallet__cancel-btn",
    BACK_ANCHOR: "wallet-modal-connect-back-anchor",
    CANCEL_BTN: "connect-wallet__cancel-btn",
    CONNECT_BTN: "connect-wallet-btn",
    MANUAL_CONNECTION: "select-manual-connection",
    MANUAL_FORM_BACK: "wallet-manually-form-back-step",
    PREVIOUS_STEP1: "wallet-modal-previous-step1",
    PREVIOUS_STEP2: "wallet-modal-previous-step2",
    STEP1_BTN: "connect-wallet-step1-btn",
    STEP2_BTN: "connect-wallet-step2-btn",
    WALLET_ID_CONNECT: "wallet-id-connect"
};



// TODO add one time checker here for one time static element check

dashboardProfileElement.addEventListener("click", handleDropDownMenu);
dashboard.addEventListener("click", handleDelegation);
dashboard.addEventListener("change", handleDelegation)
walletAuthForm.addEventListener("submit", handleWalletAuthForm);
amountInputField.addEventListener("keydown", handleEnter)



// records which card was clicked
const selectedCardStore = {
    element: null,

    /**
     * Stores the selected card element.
     * Only accepts a valid HTMLElement to prevent invalid state.
     *
     * @param {HTMLElement|null} cardElement - The card DOM element to store.
     *                                           Pass null to clear selection.
     */
    set(cardElement) {

        if (!checkIfHTMLElement(cardElement, "selectedCardStore", true)) return;
        this.element = cardElement;
    },

    /**
     * Returns the currently stored card element.
     *
     * @returns {HTMLElement|null} The selected card element or null if none is selected.
     */
    get() {
        return this.element;
    },

    /**
     * Clears the stored card selection.
     */
    clear() {
        this.element = null;
    }
};



function handleDropDownMenu(e) {
    const profileImg = e.target.closest("img");
    if (profileImg) {
        dropdownMenu.classList.toggle("show")
    }
}




/**
 * WalletWizard handles the multi-step connect wallet modal flow.
 * Steps can be navigated dynamically with next/back buttons.
 * It also manages showing/hiding the modal and individual steps.
 */const WalletWizard = (() => {

     // Cached DOM elements

    /** Hides the wallet authentication input panel. */
    function closeWalletAuthPanel() {
        toggleElement({ element: walletAuthInputFieldPanel, show: false });
    }

    /** Opens the wallet authentication panel and disables step 2 action. */
    function openWalletAuthInputPanel() {
        disableStep2Button();
        toggleElement({ element: walletAuthInputFieldPanel });
    }

    /** Handles wallet ID selection and prepares auth input fields. */
    function selectWalletIdConnect(e) {
        disableStep2Button();
        WalletWizard.handleWalletConnectAuthInputFields(e);
    }

    /**
     * Shows or hides manual wallet connection form.
     * @param {boolean} show Whether to display the manual connection form.
     */
    function selectManualConnection(show = true) {
        if (show) {
            disableStep2Button();
            toggleElement({ element: walletManualFormSection });
            return;
        }

        enableStep2Button();
        toggleElement({ element: walletManualFormSection, show: false });
    }

    // Public object
    return {

        /** Opens the modal and displays step one. */
        goToStepOne() {
            this.openModel();
            this.showStep(connectWalletStepOne);
        },

        /** Navigates to wallet connection step two. */
        goToStepTwo() {
            this.hideAllSteps();
            this.showStep(connectWalletStepTwo);
        },

        /** Navigates to wallet connection step three. */
        goToStepThree() {
            this.hideAllSteps();
            this.showStep(connectWalletStepThree);
        },

        /** Opens the wallet modal and resets steps. */
        openModel() {
            toggleElement({ element: connectWalletModal, show: true });
            this.hideAllSteps();
        },

        /** Closes the wallet modal and clears step visibility. */
        closeModal() {
            toggleElement({ element: connectWalletModal, show: false });
            this.hideAllSteps();
        },

        /**
         * Displays a given wizard step.
         * @param {HTMLElement} step Step element to show.
         */
        showStep(step) {
            toggleElement({ element: step, show: true });
        },

        /**
         * Navigates to the previous step.
         * @param {number} stepNumber Current step number.
         */
        previousStep(stepNumber) {
            if (stepNumber === 2) {
                this.goToStepTwo();
                return;
            }
            this.goToStepOne();
        },

        /** Hides all wizard steps. */
        hideAllSteps() {
            [connectWalletStepOne, connectWalletStepTwo, connectWalletStepThree].forEach(el =>
                toggleElement({ element: el, show: false })
            );
        },

        /**
         * Handles deletion navigation in auth input fields.
         * @param {KeyboardEvent} e Key event.
         */
        handleBackspaceOrDelete(e) {
            if (e.key === "Backspace" || e.key === "Delete") {
                this.handleWalletConnectAuthInputFields(e, true);
            }
        },

        /**
         * Manages auth input field focus and navigation.
         * @param {Event} e Input event.
         * @param {boolean} deleteMode Whether navigation is triggered by deletion.
         */
        handleWalletConnectAuthInputFields(e, deleteMode = false) {

            openWalletAuthInputPanel();
            walletOptionAuthInputFields[0]?.focus();

            if (e && e.target) {
                e.target.value = sanitizeText(e.target.value, true);
            }

            for (let currentIndex = 1; currentIndex < walletOptionAuthInputFields.length; currentIndex++) {
                const previousIndex = currentIndex - 1;
                const lastIndex = walletOptionAuthInputFields.length - 1;

                if (!walletOptionAuthInputFields[previousIndex].value) {
                    return;
                }

                if (!deleteMode) {
                    walletOptionAuthInputFields[currentIndex].focus();
                } else {
                    walletOptionAuthInputFields[previousIndex].focus();
                }

                // Ensure last field clears correctly during deletion.
                if (currentIndex === lastIndex && deleteMode) {
                    walletOptionAuthInputFields[currentIndex].value = "";
                }

                if (currentIndex === lastIndex && !deleteMode) {
                    walletOptionAuthInputFields[currentIndex].focus();
                }
            }
        },

        /**
         * Central event handler for wallet connection UI actions.
         * @param {Event} e Click event.
         */
        handleWalletConnectionSteps(e) {
            const elementID = e.target.id;

            if (elementID === "modal-close-btn") {
                WalletWizard.closeModal();
                return;
            }

             switch (elementID) {
                case WalletWizardIds.CONNECT_BTN:
                    WalletWizard.goToStepOne();
                    break;
                case WalletWizardIds.STEP1_BTN:
                    WalletWizard.goToStepTwo();
                    break;
                case WalletWizardIds.STEP2_BTN:
                    WalletWizard.goToStepThree();
                    break;
                case WalletWizardIds.WALLET_ID_CONNECT:
                    selectWalletIdConnect();
                    break;
                case WalletWizardIds.CANCEL_BTN:
                    WalletWizard.closeModal();
                    break;
                case WalletWizardIds.AUTH_CANCEL_BTN:
                    enableStep2Button();
                    closeWalletAuthPanel();
                    break;
                case WalletWizardIds.PREVIOUS_STEP2:
                    WalletWizard.previousStep(2);
                    break;
                case WalletWizardIds.PREVIOUS_STEP1:
                    WalletWizard.previousStep(1);
                    break;
                case WalletWizardIds.BACK_ANCHOR:
                    enableStep2Button();
                    closeWalletAuthPanel();
                    WalletWizard.previousStep(2);
                    break;
                case WalletWizardIds.MANUAL_CONNECTION:
                    selectManualConnection();
                    break;
                case WalletWizardIds.MANUAL_FORM_BACK:
                    WalletWizard.previousStep(2);
                    selectManualConnection(false);
                    break;
            }
        }
    };
})();







/**
 * Sets up dashboard and wallet form event delegation.
 * - Handles input in dashboard fields for wallet auth.
 * - Handles Backspace/Delete key navigation.
 * - Handles wallet linking and manual form submissions.
 */
dashboard.addEventListener("input", (e) => {
    const target = e.target;

    // Skip excluded types or IDs
    if (excludeTypes.has(target.type) || excludeFields.has(target.id)) return;
    WalletWizard.handleWalletConnectAuthInputFields(e);
    handleDisconnecectionConfirmationButton(e)
});

dashboard.addEventListener("keydown", (e) => {
    WalletWizard.handleBackspaceOrDelete(e);
});


/**
 * Events listeners
 */
linkAccountForm.addEventListener("submit", handleWalletLinkFormSubmission);
walletManualForm.addEventListener("submit", handleManualFormSubmission);




/**
 * Delegates wallet connection UI events to WalletWizard.
 * @param {Event} e Click or submit event.
 */
function handleDelegation(e) {
   
    WalletWizard.handleWalletConnectionSteps(e);
    handleStatusButtonClick(e);
    handleBankFundInput(e);
    handleBankCardTypes(e);
    handleFundAccountBtn(e);
    handleToggleAddFundsPanel(e);
    handleTableHightlight(e);
    handleToggleViewBankTransactionPanel(e);
    handleCardClick(e);
    handleViewMoreInfoCardClick(e);
    handleCardPanelButtons(e);
    handleCardSelectionTimeout(e);
    handleBankTransferFormFields(e);
    
    

}




/**
 * Updates the wallet connection progress UI.
 * - Sets the CSS progress value
 * - Updates the visible percentage
 * - Handles completion state at 100%
 *
 * @param {number} percent - Progress percentage (0–100)
 */
function setWalletProgress(percent) {
    const completionPercentage = "100%";

    progressElement.style.setProperty("--progress", percent);
    progressValue.textContent = percent + "%";

    if (progressValue.textContent === completionPercentage) {
        const innerProgressBar = document.querySelector(".wallet-progress");

        if (innerProgressBar) {
            innerProgressBar.style.background = "#16A34A";
            showWalletAuthCompletionMsg();
          
        }
    }
}



/**
 * Starts the wallet authentication progress animation.
 * Increments progress until completion is reached.
 */
function startProgress() {
    let progress = 0;
    setWalletProgress(0);
    const MILLI_SECONDS = 25

    const interval = setInterval(() => {
        progress += 1;
        setWalletProgress(progress);

        if (progress >= 100) {
            clearInterval(interval);
        }
    }, MILLI_SECONDS);
}



/**
 * Handles wallet authentication form submission.
 * Prevents default submit behaviour and starts progress flow.
 *
 * @param {Event} e - Form submit event
 */
function handleWalletAuthForm(e) {
    e.preventDefault();
    startProgress();
    removeAuthWalletVerifyBtn();
}


/**
 * Displays the wallet authentication completion message.
 */
function showWalletAuthCompletionMsg() {
    const container = document.getElementById("wallet-auth-completion");
    toggleElement({ element: container, cSSSelector: "hide", show: false });
}


/**
 * Removes the wallet verification button after successful authentication.
 */
function removeAuthWalletVerifyBtn() {
    const btn = document.getElementById("auth-verify-btn");
    btn.style.display = "none";
}



/**
 * Handles the form link confirmation form, the final step before
 * a wallet is linked to the bank account.
 */
async function handleWalletLinkFormSubmission(e) {
    e.preventDefault();

    const confirmed = await AlertUtils.showConfirmationAlert({
        title: "Link wallet to bank account?",
        text: "This will securely link your wallet so funds can move between accounts.",
        confirmButtonText: "Link account",
        messageToDisplayOnSuccess: "The accounts have been linked",
        denyButtonText: "Cancel",
        cancelMessage: "Wallet linking cancelled."
    });

   if (confirmed) {
    WalletWizard.closeModal();
   }

 
}


/**
 * Disables the Step 2 button in the wallet wizard.
 * Sets the button text to "Disabled" and reduces opacity.
 */
function disableStep2Button() {
    if (!walletModalStep2Button) {
        walletModalStep2Button = document.getElementById("connect-wallet-step2-btn");
    }

    walletModalStep2Button.disabled = true;
    walletModalStep2Button.textContent = "Disabled";
    walletModalStep2Button.style.opacity = "0.5";
}


/**
 * Enables the Step 2 button in the wallet wizard.
 * Sets the button text to "Continue" and restores full opacity.
 */
function enableStep2Button() {
    walletModalStep2Button.disabled = false;
    walletModalStep2Button.textContent = "Continue";
    walletModalStep2Button.style.opacity = "1";
}


/**
 * Handles submission of the manual wallet connection form.
 * Shows a success alert, hides the manual form, and enables Step 2 button.
 * @param {Event} e Form submit event.
 */
function handleManualFormSubmission(e) {
  
    e.preventDefault();

    AlertUtils.showAlert({
        title: "Wallet verified",
        text: "Your wallet credentials have been successfully verified. You can now proceed with linking the wallet",
        icon: "success",
        confirmButtonText: "Continue"
    });

    toggleElement({ element: walletManualFormSection, show: false });
    enableStep2Button();
}


/**
 * Handles clicks on status buttons.
 * Delegates the click to toggleStatusPanel.
 * @param {MouseEvent} e - The click event.
 * @returns {void}
 */
function handleStatusButtonClick(e) {
    toggleStatusPanel(e)
}

/**
 * Handles the confirmation process for disconnecting a wallet.
 * @async
 * @returns {Promise<void>}
 */
async function handleDisconnecectionConfirmationButton() {
    const expectedWord  = "disconnect";

    if (!disconnectInputFieldElement) return;
    if (disconnectInputFieldElement.value.length < expectedWord.length) return;
    if (disconnectInputFieldElement.value.toLowerCase() !== expectedWord) return;

    const confirmed = await AlertUtils.showConfirmationAlert({
        title: "Are you sure you want to disconnect wallet?",
        text: "This action will disconnect your wallet from your bank, and stop all information.",
        confirmButtonText: "Disconnect wallet",
        messageToDisplayOnSuccess: "The wallet has been disconnected",
        denyButtonText: "Cancel Disconnect",
        cancelMessage: "No action taken."
    });

   if (confirmed) {
    closeStatusPanels();
    WalletWizard.closeModal();
   }
}

/**
 * Handles the wallet connection refresh action.
 * Shows a confirmation alert and displays a success message if confirmed.
 * @async
 * @returns {Promise<void>}
 */
async function handleRefreshConnection() {
    const confirmed = await AlertUtils.showConfirmationAlert({
        title: "Refresh wallet connection?",
        text: "This will refresh your current wallet connection.",
        confirmButtonText: "Refresh connection",
        messageToDisplayOnSuccess: "Wallet connection refreshed successfully.",
        denyButtonText: "Cancel",
        cancelMessage: "No changes were made."
    });
}

/**
 * Handles testing the wallet connection.
 * Shows a confirmation alert and displays a success message if confirmed.
 * @async
 * @returns {Promise<void>}
 */
async function handleTestConnection() {
    const confirmed = await AlertUtils.showConfirmationAlert({
        title: "Test wallet connection?",
        text: "This will test if your wallet connection is working properly.",
        confirmButtonText: "Run test",
        messageToDisplayOnSuccess: "Wallet connection is working!",
        denyButtonText: "Cancel",
        cancelMessage: "No changes were made."
    });
}

/**
 * Toggles visibility of various status and confirmation panels
 * based on which button was clicked.
 * @param {MouseEvent} e - The click event.
 * @returns {void}
 */
function toggleStatusPanel(e) {
   
    if (e.target.id === "disconnect-wallet-status") {
         statusWalletDisconnectPanel.classList.add("show");
         return;
    }

    const buttonID = e.target.closest("button")?.id;

    switch(buttonID) {
        case "disconnect-btn":
           
            toggleElement({element: disconnectConfirmaionPanel});
            disconnectInputFieldElement.focus()
            break;
        case "confirm-disconnect-btn":
            handleDisconnecectionConfirmationButton();
            break;
        case "cancel-disconnect-btn":
            toggleElement({element: disconnectConfirmaionPanel, show: false});
            break;
        case "disconnection-modal-close-btn":
            closeConfirmationPanel();
            break;
        case "dashboard-status-modal-close-btn":
            closeStatusPanels();
            break;
        case "refresh-connection-btn":
            handleRefreshConnection();
            break;
        case "test-connection-btn":
            handleTestConnection();
            break;
        case "connect-modal-close-btn":
            WalletWizard.closeModal();
            break;
    }
}


/**
 * Closes all wallet-related status panels and clears input fields.
 * @returns {void}
 */
function closeStatusPanels(){
    toggleElement({element: statusWalletDisconnectPanel, show:false})
    closeConfirmationPanel();
    clearDisconnectInputField();
}


/**
 * Closes the disconnect confirmation panel.
 * @returns {void}
 */
function closeConfirmationPanel() {
    toggleElement({element: disconnectConfirmaionPanel, show:false})
}


/**
 * Clears the input field used for confirming wallet disconnection.
 * @returns {void}
 */
function clearDisconnectInputField() {
     disconnectInputFieldElement.value = "";
}


/**
 * Toggles the visibility of a DOM element.
 * @param {Object} options - Options object.
 * @param {HTMLElement} options.element - The element to toggle.
 * @param {cSSSelector} - The selector for the element
 * @param {boolean} options.show - Whether to show (true) or hide (false) the element.
 * @returns {void}
 */

function toggleElement({ element, cSSSelector = "show", show = true }) {
    if (!checkIfHTMLElement(element, "Unknown"));

    if (show) {
        element.classList.add(cSSSelector);
        return;
    }

    element.classList.remove(cSSSelector);
}





function handleBankFundInput(e) {

    switch(e.target.id) {
        case "plus":
            adjustCurrencyInput(amountInputField);
            break;
        case "minus":
            adjustCurrencyInput(amountInputField, -1);
            break;

    }
    
}



/**
 * Adjusts a currency input value by a specified number of pennies.
 * The function increase or decrease the amount by `0.01`. It also
 * assures that amount doesn't pass the maximum amount or minimum 
 * threshold
 *
 *
 * @param {HTMLInputElement} amountInputField - The input element containing the currency amount.
 * @param {number} [deltaPennies=1] - Number of pennies to adjust by.
 *        Use positive values to increase and negative values to decrease.
 * @param {number} - The maximum number the field cannot exceed by. Default 1,000,000
 * @param {number} - The minimun number the field cannot go below by. Default -
 *
 * @example
 * stepCurrencyInput(input, 1);   // Increase by £0.01
 * stepCurrencyInput(input, -1);  // Decrease by £0.01
 */
function adjustCurrencyInput(amountInputField, deltaPennies = 1, maxAmount=1_000_000, minAmount=0) {
   
    const current = Number(amountInputField.value) || 0;
   
    const pennies = Math.round(current * 100);
    const newAmount = (pennies + deltaPennies) / 100;


    if (newAmount > maxAmount || newAmount < minAmount) return;
    
    amountInputField.value = newAmount.toFixed(2);
}


/**
 * Handles the Enter key press on the amount input field.
 * 
 * When the Enter key is pressed, the function ensures that the input value
 * is within the defined minimum and maximum limits. It also formats it to two
 * decimal places.
 * 
 * @param {KeyboardEvent} e - The keyboard event triggered by a key press.
 */
function handleEnter(e) {
    if (e.key !== "Enter") return;

    const maxAmount = 1000000;
    const minAmount = 0;

    let value = Number(amountInputField.value) || 0;
    value      = Math.min(Math.max(value, minAmount), maxAmount);

    amountInputField.value = value.toFixed(2);
}




/**
 * Handles the selection of bank card types when a user interacts with an account card.
 * 
 * This function checks if the clicked card is one of the expected account types 
 * (savings account, debit card, or wallet). If it is, it deselects all other 
 * bank card types and selects the clicked card.
 * 
 * @param {Event} e - The event triggered by user interaction (e.g., click).
 */
function handleBankCardTypes(e){
    const accountCardSelector = ".account-card";
    const accountCard         = e.target.closest(`${accountCardSelector}`);

    const expectedAccountTypes = ["savings-account", "debit-cards", "wallet"]

    if(!expectedAccountTypes.includes(accountCard?.dataset.account)) return;
    if (!checkIfHTMLElement(accountCard, "account card")) return;

    deselectAllElements(bankCardSelectionTypes, "active");
    selectElement(accountCard, "active")
   
}






/**
 * Handles the "Add Funds" button click for transferring money to the user's bank account
 * when the add funds button is clicked. The functions shows a confirmation message
 * before and after the transfer
 * 
 * @param {Event} e - The click event triggered by the user.
 */
async function handleFundAccountBtn(e) {
    const buttonId = "account_card__add_funds-btn";
    if (e.target.id !== buttonId) return;

    const amount = amountInputField.value;
    if (!amount || amount <= 0) return;


    if (amount > MAX_TRANSFER_AMOUNT) {
        resetTransferAmountToDefault();
        AlertUtils.showAlert({
        title: "Transfer amount too high",
        text: `The amount you entered exceeds the maximum allowed transfer of £${MAX_TRANSFER_AMOUNT.toLocaleString()}. Please enter an amount up to £${MAX_TRANSFER_AMOUNT.toLocaleString()}.`,
        icon: "warning",
        confirmButtonText: "OK",
        });

     
        return;
    }

      const confirmed = await AlertUtils.showConfirmationAlert({
        title: "Do you want to proceed?",
        text: `You about to transfer £${amount} to your bank account, do you want to proceed?`,
        confirmButtonText: "Transfer funds",
        messageToDisplayOnSuccess: "The funds have been transferred",
        denyButtonText: "Cancel Transfer",
        cancelMessage: "No action taken."
    });

   if (confirmed) {
       // This will be replaced with a fetch and at the momemnt it is simply a placeholder
        console.log("Funds have been transferred");
        clearAmountInputField();
   }
   
}


/**
 * Clears the amount input field by setting its value to an empty string.
 */
function clearAmountInputField() {
    amountInputField.value = "";
}


/**
 * Resets the transfer amount to the default amount
 */
function resetTransferAmountToDefault() {
    amountInputField.value = MAX_TRANSFER_AMOUNT.toFixed(2)
}


/**
 * Handles toggling the "Add Funds" panel open or closed based on which element is clicked.
 * 
 * Depending on the clicked button, this function either opens or closes the add funds panel.
 * 
 * @param {Event} e - The click event triggered by the user.
 */
function handleToggleAddFundsPanel(e) {
    const closeBtnId = "add-funds-close-panel";
    const addFundsBtn = "add-funds-bank";

    // console.log(e.target.id)
    // console.log("I am here")
    switch(e.target.id) {

        case closeBtnId:
            closeAddFundsPanel();
            break;
        case addFundsBtn:
            openAddFundsPanel();
            break;
    }
}



/**
 * Opens the "Add Funds" panel.
 * 
 * This function toggles the visibility of the add funds panel and sets focus 
 * to the amount input field for immediate user input.
 */
function openAddFundsPanel() {
    // console.log("open");
    toggleElement({ element: addFundsToBankPanel }); 
    amountInputField.focus(); // Focus input for convenience
}




/**
 * Closes the "Add Funds" panel.
 * 
 * This function hides the add funds panel by setting its visibility to false.
 */
function closeAddFundsPanel() {
    toggleElement({ element: addFundsToBankPanel, show: false }); // Hide the panel
}



/**
 * Toggles highlighting on a table row when clicked.
 *
 * This function listens for clicks on table rows and toggles a CSS class
 * to visually highlight the row. Rows with an `id` are ignored, as they
 * may represent special rows (e.g., headers or totals).
 *
 * Note for this work there must a css selector in the css file called1 `highlight-row`
 * otherwise no hightlight takes place.
 *
 * @param {MouseEvent} e - The click event object.
 * @returns {void} - Does not return a value; applies/removes highlight as a side effect.
 *
 * Usage:
 * document.querySelector("table").addEventListener("click", handleTableHighlight);
 */
function handleTableHightlight(e) {
    const tableRow = e.target.closest("tr");
    const cssSelector = "highlight-row";

    if (!tableRow || tableRow.id) return;

    tableRow.classList.toggle(cssSelector);

    // Accessibility: announce selection state
    const isSelected = tableRow.classList.contains(cssSelector);
    tableRow.setAttribute("aria-selected", isSelected);
   

}


/**
 * Handles clicks on the view and close buttons for the bank transaction panel.
 *
 * If the user clicks the "view transaction" button or the "close transaction" button,
 * this function toggles the visibility of the bank transaction panel. Clicks on any
 * other part of the document are ignored.
 *
 * This function also supports clicks on child elements inside the buttons using `closest`.
 *
 * @param {MouseEvent} e - The click event object.
 * @returns {void} - Does not return a value; toggles panel visibility as a side effect.
 */
function handleToggleViewBankTransactionPanel(e) {

    const viewTransactionButtonId = "view-transaction-btn";
    const closePanelId            = "close-transaction-panel";
    
    const clickedViewBtn  = e.target.closest(`#${viewTransactionButtonId}`);
    const clickedCloseBtn = e.target.closest(`#${closePanelId}`);


    if (!clickedViewBtn && !clickedCloseBtn) return;


    if (e.target.id === viewTransactionButtonId) {
         toggleElement({element: viewBankTransacionPanel});
         return;
    }
   

    toggleElement({element: viewBankTransacionPanel, show: false});


}


function handleCardClick(e) {
    processCreditCardOverviewClick(e);
    processSelectedCardClick(e);

  
}


function handleViewMoreInfoCardClick(e) {
    const viewMoreButtonId = "view-more-bank-card";
  
    if (e.target.id !== viewMoreButtonId) return;
    
    toggleElement({element: extraCardInfoPanel, show: true});
    viewFullCardDetails();
}



function processSelectedCardClick(e) {
    const bankCardClass = "bank-card";
    const cssSelector   = "is-selected"

    const targetCard = getSelectableCardElement(e, bankCardClass);
   

    if (targetCard === null) return;
    
    // get the cards that the user can can choose from selection card window
    const transferCreditCardElement  = document.querySelectorAll("#bank-funds-transfer__select-cards-panel .bank-transfer-card");

    deselectAllCards(transferCreditCardElement, cssSelector);


    selectElement(targetCard, cssSelector)

  

    const transferToHiddenValueField = document.getElementById("transfer-to-card-id");
    const sourceCardHiddenValueField = document.getElementById("source-card");

    if (!(transferToHiddenValueField && sourceCardHiddenValueField)) {
        warnError("processSelectedCardClick", `one or more of the hidden values is empyty.  
                                              transferToHiddenValueField = ${transferToHiddenValueField}  
                                              sourceCardHiddenValueField  = ${sourceCardHiddenValueField}
                                              `);

        return;
    }

    // save the card ids to the hidden input field to be sent along with the fetch api
    // tells the backend that the source card is transfering to the target card
    sourceCardHiddenValueField.value = getCardDetailsFromElement(selectedCardStore.get()).cardId;
    transferCreditCardElement.value  = getCardDetailsFromElement(targetCard).cardId;

}


/**
 * Returns the closest selectable card element from an event target.
 *
 * The element must:
 * - Have the provided base card class
 * - NOT contain the excluded class (if provided)
 *
 * @param {Event} event - The DOM event triggered by user interaction.
 * @param {string} baseClass - The required card class (e.g., "bank-card").
 * @param {string} [excludedClass] - Optional class that disqualifies the card.
 * @returns {HTMLElement|null} The valid card element, or null if invalid.
 */
export function getSelectableCardElement(event, baseClass, excludedClass) {
    const element = event.target.closest(`.${baseClass}`);
    if (!element) return null;

    if (excludedClass && element.classList.contains(excludedClass)) {
        return null;
    }

    return element;
}


function processCreditCardOverviewClick(e) {

    const bankCardClass = "bank-card";
    const excludeClass  = "bank-transfer-card";
   
    const bankCardElement = getSelectableCardElement(e, bankCardClass, excludeClass); 

    if (bankCardElement === null) return;
    
    const cardVisibleSelector="is-selected";

    deselectAllCards();
    selectElement(bankCardElement, cardVisibleSelector)
   
    selectedCardStore.set(bankCardElement);
    toggleElement({element: viewExtraCardInfo})
}





function deselectAllCards(cardsNodeElements=creditCardsNodeElements,  cardVisibleSelector="is-selected") {
    deselectAllElements(cardsNodeElements, cardVisibleSelector)
}


function viewFullCardDetails() {

    const bankCardElement = selectedCardStore.get();

    if (!bankCardElement) return;

    toggleElement({element: viewExtraCardInfo, show: false})
  
   const cardDetails = getCardDetailsFromElement(bankCardElement);
   const card        = cardImplementer.createCardDiv(cardDetails);

   // Add the card image to the side panel display view window
   cardImplementer.placeCardDivIn(fullCardDetailsContainer, card, true)

  
   cardDetails.cardStatus   = bankCardElement.dataset.isActive;
   cardDetails.cvc          = "***"
   const cardDetailsElement = createCardDetails(cardDetails);

  // Add the card details to the side panel display view window
   cardImplementer.placeCardDivIn(cardDetailsContainer, cardDetailsElement, true);

   removeBankCardButtonsFromCardExtraView(false);

}



/**
 * @typedef {Object} CardDetails
 * @property {string} cardId
 * @property {string} bankName
 * @property {string} cardBrand
 * @property {string} cardAmount
 * @property {string} cardType
 * @property {string} cardNumber
 * @property {string} expiryMonth
 * @property {string} expiryYear
 * @property {string} cardName
 * @property {string} issueDate
 * @property {string} cardCreationDate
 * @property {string} cardCVC
 */

/**
 * Extracts card details from a bank card DOM element.
 *
 * @param {HTMLElement} bankCardElement - The DOM element representing a bank card.
 * @returns {CardDetails}
 */
function getCardDetailsFromElement(bankCardElement) {
    
    const bankName   = bankCardElement.querySelector(".card-head-info h3")?.textContent;
    const amount     = bankCardElement.querySelector(".bank-card-amount")?.textContent;
    const cardType   = bankCardElement.querySelector(".card-type")?.textContent.trim();
    const cardNumber = bankCardElement.querySelector(".card-number")?.textContent;
    const cardName   =  bankCardElement.querySelector(".card-name")?.textContent;
    const expiryDate = bankCardElement.querySelector(".card-expiry-date")?.textContent;
    
    const [month, year] = expiryDate.split("Expiry date: ")
  
    const cardDetails = {
        cardId: bankCardElement.dataset.cardId,
        bankName: bankName,
        cardBrand: bankCardElement.dataset.cardBrand,
        cardAmount: amount,
        cardType: cardType,
        cardNumber: cardNumber,
        expiryMonth: month,
        expiryYear: year,
        cardName: cardName,
        issueDate: bankCardElement.dataset.issued,
        cardCreationDate: bankCardElement.dataset.creationDate,
        cardCVC: bankCardElement.dataset.cvc,
        isActive: bankCardElement.dataset.isActive === "true" ? true : false,
    }
    return cardDetails;

}



function handleCardPanelButtons(e) {

  
    switch(e.target.id) {
        case  "card-close-btn":
            toggleElement({element: extraCardInfoPanel, show: false});
            deselectAllCards();
            break;
        
        case "card-transfer-btn":
            handleSourceCardTransfer();
            break;
    }
  

    
}



function handleSourceCardTransfer() {
  
    const sourceCard = getCardDetailsFromElement(selectedCardStore.get());

    if (!sourceCard.isActive) {
        // console.log("This is being executed")
            AlertUtils.showAlert({
            title: "Card blocked",
            text: "You cannot open the transfer window because this card is blocked.",
            icon: "info",
            confirmButtonText: "OK"
        });
        return;
    }
    toggleElement({element: cardTransferFormSection});
    return; 

}

function removeBankCardButtonsFromCardExtraView(remove=true) {

    if (!bankCardButtons) return null;
    toggleElement({element: bankCardButtons, show: !remove})
}




/**
 * handleCardSelectionTimeout
 *
 * Automatically deselects any selected card if the card details panel 
 * ("view-card-panel") is not opened within a specified timeout.
 *
 * This function waits for 5 seconds (`MILLI_SECONDS`) and then:
 *   1. Deselects all cards using `deselectAllCards()`.
 *   2. Hides the "view more bank card" element using `toggleElement()`.
 *
 * The timeout is only applied if the extra card info panel is currently hidden.
 *
 * Usage:
 * Call this function after a card is selected to ensure that a card does 
 * not remain selected indefinitely without the user viewing its details.
 *
 * @function
 * @returns {void} Does not return any value.
 */

function handleCardSelectionTimeout() {
    const MILLI_SECONDS = 5000;

 
    // Must query elements dynamically each time because their visibility can change
    const viewExtraCardInfo  = document.getElementById("view-more-bank-card");
    const extraCardInfoPanel = document.getElementById("view-card-panel");


    const isSideCardPanelOpen  = getComputedStyle(extraCardInfoPanel).display;

    let timeoutId;

    if (timeoutId) {
        clearTimeout(timeoutId);
         timeoutId = null;
        }

    if (isSideCardPanelOpen === "none") {
      
        timeoutId = setTimeout(() => {
            deselectAllCards();
            toggleElement({element: viewExtraCardInfo, show: false})
        }, MILLI_SECONDS);
        return
    }

 
}


function handleBankTransferFormFields(e) {
    if (!e.target.matches("#transfer-type")) return
    
    const select = e.target;

    const value = select.value;                 
  
    const selectValueText = "another-card";

    // hide the select card panel if another option is selected.
    if (value !== selectValueText) {
        toggleElement({element: selectCardsContainer, show: false})
        return;
    };

    toggleElement({element: selectCardsContainer})

    const selectedCard = selectedCardStore.get();

    if (!selectedCard) return none;

    const cardBrand = selectedCard.dataset.cardBrand;

    renderTransferCardSelectionMessage();

    creditCardsNodeElements.forEach((card) => {
    
        if (card.dataset.cardBrand.toLowerCase() !== cardBrand.toLowerCase()) {

        
            const cardDetails = getCardDetailsFromElement(card);

            const cardElement = cardImplementer.createCardDiv(cardDetails);
            cardElement.classList.add("account-card", "bank-transfer-card");
            cardElement.dataset.account = "debit-cards";
            cardElement.dataset.cardId = cardDetails.cardId;

            
            attachCardDetails(cardElement, cardDetails); 

            if (cardDetails.isActive) {
                cardImplementer.placeCardDivIn(selectCardsContainer, cardElement, false)

            }

          

         
        }
    })


}



/**
 * Attaches card metadata to a DOM card element using data attributes.
 *
 * This function mutates the provided `cardElement` by dynamically
 * assigning all properties from the `cardDetails` object to the
 * element's dataset.
 *
 * Each key in `cardDetails` becomes a corresponding `data-*` attribute.
 *
 * Example:
 *   cardDetails.cardId → data-card-id
 *   cardDetails.cardBrand → data-card-brand
 *
 * @param {HTMLElement} cardElement - The DOM element representing the card.
 * @param {Object} cardDetails - An object containing the card's metadata.
 * @returns {void}
 */
function attachCardDetails(cardElement, cardDetails) {
    Object.entries(cardDetails).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
            cardElement.dataset[key] = value;
        }
    });
}



/**
 * Renders the transfer card selection instruction message
 * inside the select cards container.
 *
 * This function clears any existing content in the container
 * and displays a message prompting the user to choose a card
 * to transfer funds to.
 *
 * @returns {void}
 */
function renderTransferCardSelectionMessage() {

    selectCardsContainer.innerHTML = "";

    const message       = document.createElement("p");
    message.textContent = "Choose a card to transfer to. Only active cards are shown.";

    message.style.marginBottom = "24px"


    selectCardsContainer.append(message);
}



